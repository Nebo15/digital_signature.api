language: elixir
cache:
  directories:
    - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.3
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=edenlabllc
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker and GitHub credentials
    - secure: "uceBiEXXOVuv0GVSjdC0G4yMoC/d4rOVW9B+CdKNIoTy7yB8wLxBoeLzuVFonX2BHXcBCkH07H+oMgrTpIJSj5r2TS/MrbCdphWeeuQ7LsEWKtUZsWl6Q0cdRtls67mlIjGYU+IVK4YcCOyUdcZemtj789poTx+YMyYypxEVLmITkjlqTdi7nGjETJ5weXyIYB5PsVONGJSfCOiZ0ebm9itQypUAoMXu3XGGZKgA0TKTQ4A7q1c8bbpEU1UNg8fm5p4IogJgecx9rY18tj1v9bQJ4n6sHke+cePcLk8zEsMZhvuTbeJPZYJdxTdJm/myZQirs9De5PM5Qu/i64sOefocXcUYu/53s4n1z6VN/UH2SpfZLuBO57NN3fkCwO1TB5BDDdVwZn1/oCzFO/LhWPZLn5/Of0vnv406lhofxpCSpDpHxFc6M9JICSaOO15t6PP63GSkYcNcmw6ylyBeC+7piSOAkRPiVfeTbUGjRxOP7EC61VO6lPlQr8DIjcb0kLpxpyP+IZCtNg0e/yrlqEIrvONRUqqEoXu5fo2zbOuXBC9eXVklrK/gReU2pkitsLKqfvjACG/BRD5MZX4M3ZhVHbYbG5Wat9GqkHWkg1OT9Z6yBTAtvQm5QspNmm1uSeu965B5xUnaL1OMMW3qvw3ZwX0MLetumHnLqmB7rFg="
    - secure: "Fuh3rEp/Z+NTwFKjJhXwHuBGOFWfEA7RFrHVBTv3/AB6Ef2j5t65AHNjtA4VrK4LXepvRZ5r9hhVWIQ87wEk546aVKdO1p+SP/2Eh+EmG/R/gzQpbYQJIWnw775ng85zXFe18JjTyL7UfEjL1apgoqKtx9THrrsLQPWpGrMuTZOLiFcKj9t6xlMYufsAs3Rzd3N2RNktW6gbs3Z/cR0xAtBjsYF7ptMWk1uxOvr49DNYZKSG/qZvJpczSeAhiDqVYu8A1o04eNlunudikemN3hCzYNc7F9bwYLjUQY8LENCh00lrPXLGBPO4M0klAG3xoXH2ySNskQOBJ1GPTwpKYUupukwhAVvc/NIUoHM1lEB/ztTD12L79mDuRgEwMzaxaHa9M+ybPzqmef+0guf5WynHIk1MbmBlzQGSEzmai3ZZjrk4GL4TLwlOktqtJF0cSZ4ONiFsZtG/HcvQcMpuFMlB2/wahJ6zWoEG/wrcLQpNUqboYLWn0o6/f8M1lrQM7+f3s25Hh+rfB7DqcTkZEldufkRhJHUa7eKJ642u3uhydRJs7pK1K5EyxEwm2fBnQ0dcvObeLjFJ3HcA6HL9YPxgp1ILGgqM5qezFVwAVJdb2qaRj8HI/Qx8jcVb7kmfXJxxpLDT3/zhDNcEKngc0bOwUXgl8kQ/KESAdXqjMVo="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - MIX_ENV=dev mix ecto.setup
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs digital_signature_api --details --since 5h;
      exit 1;
    fi;
after_failure:
  - docker logs digital_signature_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
